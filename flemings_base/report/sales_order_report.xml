<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Sales Order Report -->
        <template id="report_fg_sales_order_doc">
            <style>
                td {word-break: break-word !important; word-spacing: 3px !important; padding:5px; page-break-inside: avoid !important;}

                .non-border, .non-border > tr, .non-border > tr > td {
                    border: none !important; border-color: #ffffff !important;
                }
            </style>

            <t t-if="o and 'company_id' in o">
                <t t-set="company" t-value="o.company_id.sudo()"/>
            </t>
            <t t-if="not o or not 'company_id' in o">
                <t t-set="company" t-value="res_company"/>
            </t>

            <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:5px;">
                <thead>
                    <tr>
                        <td style="width:5%; padding:5px; border-top:1px solid black; border-bottom:1px solid black; font-weight:bold; text-align:left;">S/N</td>
                        <td style="width:40%; padding:5px; border-top:1px solid black; border-bottom:1px solid black; font-weight:bold; text-align:left;">Product Code / Description</td>
                        <td style="width:8%; padding:5px; border-top:1px solid black; border-bottom:1px solid black; font-weight:bold; text-align:center;">Qty</td>
                        <td style="width:12%; padding:5px; border-top:1px solid black; border-bottom:1px solid black; font-weight:bold; text-align:center;">UOM</td>
                        <td style="width:12%; padding:5px; border-top:1px solid black; border-bottom:1px solid black; font-weight:bold; text-align:center;">Unit Price</td>
                        <td style="width:10%; padding:5px; border-top:1px solid black; border-bottom:1px solid black; font-weight:bold; text-align:center;">Disc</td>
                        <td style="width:13%; padding:5px; border-top:1px solid black; border-bottom:1px solid black; font-weight:bold; text-align:center; white-space:nowrap !important;">Total Amount</td>
                    </tr>
                </thead>
                <t t-foreach="o.order_line.sorted(key=lambda x: x.sequence)" t-as="line">
                    <t t-if="line.display_type">
                        <tr>
                            <td style="width:5%; padding:5px; text-align:left;"/>
                            <td colspan="6" style="width:95%; padding:5px; text-align:left;">
                                <span t-field="line.name"/>
                            </td>
                        </tr>
                    </t>
                    <t t-else="">
                        <tr>
                            <td style="width:5%; padding:5px; text-align:left;">
                                <span t-field="line.fg_sno"/>
                            </td>
                            <td style="width:40%; padding:5px; padding-right:0px !important; text-align:left;">
                                <span t-field="line.product_id.default_code"/><br/>
                                <span t-field="line.product_id.variant_name"/>
                            </td>
                            <td style="width:8%; padding:5px; text-align:center;">
                                <span t-esc="'{0:,.0f}'.format(line.product_uom_qty)"/>
                            </td>
                            <td style="width:12%; padding:5px; text-align:center;">
                                <span t-field="line.product_uom"/>
                            </td>
                            <td style="width:12%; padding:5px; text-align:right;">
                                <span t-esc="'{0:,.2f}'.format(line.price_unit)"/>
                                <!--(<span t-field="line.currency_id.symbol"/>)-->
                            </td>
                            <td style="width:10%; padding:5px; text-align:right;"/>
                            <td style="width:13%; padding:5px; text-align:right;">
                                <span t-esc="'{0:,.2f}'.format(line.price_subtotal)"/>
                                <!--(<span t-field="line.currency_id.symbol"/>)-->
                            </td>
                        </tr>
                    </t>
                </t>
            </table>

            <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:5px;">
                <tr>
                    <td style="width:53%; padding:5px; border-top:1px solid black; text-align:right; padding-right:0px !important;">Total Quantity:</td>
                    <td style="width:12%; padding:5px; border-top:1px solid black; text-align:left; font-weight:bold;">
                        <span t-esc="'{0:,.0f}'.format(sum(o.order_line.mapped('product_uom_qty')))"/>
                    </td>
                    <td style="width:22%; padding:5px; border-top:1px solid black; text-align:right; font-weight:bold;">Sub Total : <span t-field="o.currency_id"/></td>
                    <td style="width:12%; padding:5px; border-top:1px solid black; text-align:right; font-weight:bold;"><span t-esc="'{0:,.2f}'.format(o.amount_untaxed)"/></td>
                </tr>
                <tr style="height:6px;"/>
                <tr>
                    <td colspan="3"/>
                    <td style="width:12%; padding:5px; border-bottom:1px solid black;"/>
                </tr>

                <tr style="height:12px;"/>
                <tr>
                    <td colspan="2" rowspan="3"/>
                    <td style="width:22%; padding:5px; text-align:right; font-weight:bold;">Tax Base : <span t-field="o.currency_id"/></td>
                    <td style="width:12%; padding:5px; text-align:right; font-weight:bold; border-bottom:1px solid black;"><span t-esc="'{0:,.2f}'.format(o.amount_untaxed)"/></td>
                </tr>

                <t t-set="tax_totals" t-value="o.tax_totals"/>
                <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
                    <t t-set="subtotal_to_show" t-value="subtotal['name']"/>
                    <t t-foreach="tax_totals['groups_by_subtotal'][subtotal_to_show]" t-as="amount_by_group">
                        <tr>
                            <td style="width:22%; padding:5px; text-align:right; font-weight:bold;">
                                <span t-esc="amount_by_group['tax_group_name']"/> : <span t-field="o.currency_id"/>
                            </td>
                            <td style="width:12%; padding:5px; text-align:right; font-weight:bold;">
                                <span t-esc="'{0:,.2f}'.format(amount_by_group['tax_group_amount'])"/>
                            </td>
                        </tr>
                    </t>
                </t>

                <tr>
                    <td style="width:22%; padding:5px; text-align:right; font-weight:bold;">Grand Total : <span t-field="o.currency_id"/></td>
                    <td style="width:12%; padding:5px; text-align:right; font-weight:bold; border-bottom:3px double black;"><span t-esc="'{0:,.2f}'.format(o.amount_total)"/></td>
                </tr>
            </table>

            <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:5px;">
                <tr>
                    <td style="width:50%; padding:5px; text-decoration:underline;">Remarks</td>
                    <td style="width:50%;"/>
                </tr>
                <tr>
                    <td style="width:50%; padding:5px;">
                        <span t-field="o.fg_remarks"/>
                    </td>
                    <td style="width:50%;"/>
                </tr>
            </table>

        </template>

        <record id="paperformat_fg_sales_order_report" model="report.paperformat">
            <field name="name">Flemings Sales Order</field>
            <field name="default" eval="True"/>
            <field name="format">A4</field>
            <field name="page_height">0</field>
            <field name="page_width">0</field>
            <field name="orientation">Portrait</field>
            <field name="margin_top">102</field>
            <field name="margin_bottom">10</field>
            <field name="margin_left">8</field>
            <field name="margin_right">8</field>
            <field name="header_line" eval="False"/>
            <field name="header_spacing">99</field>
            <field name="dpi">80</field>
        </record>

        <template id="report_fg_sales_order_document">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="flemings_base.report_fg_sales_order_custom_layout">
                        <div class="page" style="font-family:Arial !important; font-size: 10pt; margin-left: 10px !important; margin-right: 10px !important;">
                            <t t-call="flemings_base.report_fg_sales_order_doc"/>
                        </div>
                    </t>
                </t>
            </t>
        </template>

        <record id="print_report_fg_sales_order" model="ir.actions.report">
            <field name="name">Quotation / Sales Order</field>
            <field name="model">sale.order</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">flemings_base.report_fg_sales_order_document</field>
            <field name="report_file">flemings_base.report_fg_sales_order_document</field>
            <field name="binding_type">report</field>
            <field name="binding_model_id" ref="flemings_base.model_sale_order"/>
            <field name="paperformat_id" ref="paperformat_fg_sales_order_report"/>
            <field name="print_report_name">(object.state in ('draft', 'sent', 'cancel') and 'Quotation - %s' % (object.name or '').replace('/','_')) or 'Sales Order - %s' % (object.name or '').replace('/','_')</field>
        </record>

        <!-- Sales Order Report - Header Layout -->
        <template id="report_fg_sales_order_custom_header_layout">
            <div class="header">
                <style>
                    td {word-break: break-word !important; word-spacing: 1px 3px !important; padding: 1px 3px !important; page-break-inside: avoid !important;}

                    .non-border, .non-border > tr, .non-border > tr > td {
                        border: none !important; border-color: #ffffff !important;
                    }
                </style>

                <!--<t t-if="o.partner_id.child_ids.filtered(lambda x: x.type in ('contact', 'invoice'))">
                    <t t-set="contact_customer" t-value="o.partner_id.child_ids.filtered(lambda x: x.type in ('contact', 'invoice'))[0]"/>
                </t>
                <t t-else="1">
                    <t t-set="contact_customer" t-value="o.partner_id"/>
                </t>-->
                <t t-set="contact_customer" t-value="o.partner_shipping_id"/>

                <t t-if="o.partner_shipping_id">
                    <t t-set="delivery_customer" t-value="o.partner_shipping_id"/>
                </t>
                <t t-else="1">
                    <t t-set="delivery_customer" t-value="o.partner_id"/>
                </t>

                <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:3px;">
                    <thead>
                        <tr>
                            <td style="width:25%; text-align:left; padding-left:6px;">
                                <img t-if="company.logo" t-att-src="image_data_uri(company.logo)" alt="Logo" style="height:2.4cm; width:5.4cm; float:left !important"/>
                            </td>
                            <td style="width:50%; text-align:left;">
                                <div style="width:auto; padding-left:15px; font-size:8pt; float:left">
                                    <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="margin:0px !important; padding:0px !important;">
                                        <tr>
                                            <td style="margin:0px; padding:0px; text-align:left; white-space:nowrap;">
                                                <div t-field="company.name" t-attf-style="float:left; color:#000000; white-space:nowrap; font-size:19pt; font-weight:bold; padding-right:4px;"/>
                                            </td>
                                        </tr>
                                        <tr t-if="company.street or company.street2">
                                            <td style="margin:0px; padding:0px; text-align:left; white-space:nowrap;">
                                                <t t-if="company.street">
                                                    <span t-field="company.street"/>
                                                </t>
                                                <t t-if="company.street2">,
                                                    <span t-field="company.street2"/>
                                                </t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="margin:0px; padding:0px; text-align:left; white-space:nowrap;">
                                                <t t-if="company.country_id">
                                                    <span t-field="company.country_id.name"/>
                                                </t>
                                                <t t-if="company.zip">
                                                    <span t-field="company.zip"/>
                                                </t>
                                                <t t-if="company.phone">Tel:
                                                    <span t-field="company.phone"/>
                                                </t> |
                                                <t t-if="company.vat">Fax:
                                                    <span t-field="company.fax"/>
                                                </t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="margin:0px; padding:0px; text-align:left; white-space:nowrap;">
                                                <t t-if="company.company_registry">Company Reg No.:
                                                    <span t-field="company.company_registry"/>
                                                </t> |
                                                <t t-if="company.vat">GST No.:
                                                    <span t-field="company.vat"/>
                                                </t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="margin:0px; padding:0px; text-align:left; white-space:nowrap;">
                                                <t t-if="company.email">Email:
                                                    <span t-field="company.email"/>
                                                </t> |
                                                <t t-if="company.website">
                                                    <span t-field="company.website"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </td>
                            <td style="width:25%; text-align:right; padding-right:6px;">
                                <img t-if="company.sgs_img" t-att-src="image_data_uri(company.sgs_img)" alt="Logo" style="height:2cm; width:3.6cm; float:left !important"/>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3" style="width:100%; padding:3px;">
                                <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:3px;">
                                    <tr style="height:6px;"/>
                                    <tr>
                                        <td style="width:32%; text-align:left; border-top:1px solid black; vertical-align:top !important; padding-top:5px !important;">
                                            <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:3px;">
                                                <tr>
                                                    <td>Bill To: </td>
                                                </tr>
                                                <tr>
                                                    <td><span t-field="o.partner_id"/></td>
                                                </tr>
                                                <tr>
                                                    <td><span t-field="o.partner_id.street"/></td>
                                                </tr>
                                                <t t-if="o.partner_id.street2">
                                                    <tr>
                                                        <td><span t-field="o.partner_id.street2"/></td>
                                                    </tr>
                                                </t>
                                                <t t-if="o.partner_id.country_id and o.partner_id.country_id.code != 'SG'">
                                                    <td>
                                                        <span t-field="o.partner_id.city"/>
                                                        <t t-if="o.partner_id.city and o.partner_id.state_id">,&#160;</t>
                                                        <span t-field="o.partner_id.state_id"/>
                                                    </td>
                                                </t>
                                                <tr>
                                                    <td><span t-field="o.partner_id.country_id"/> <span t-field="o.partner_id.zip"/></td>
                                                </tr>
                                            </table>
                                        </td>
                                        <td style="width:32%; text-align:left; border-top:1px solid black; vertical-align:top !important; padding-top:5px !important;">
                                            <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:3px;">
                                                <tr>
                                                    <td>Deliver To: </td>
                                                </tr>
                                                <tr>
                                                    <td><span t-esc="delivery_customer.name"/></td>
                                                </tr>
                                                <tr>
                                                    <td><span t-field="delivery_customer.street"/></td>
                                                </tr>
                                                <t t-if="delivery_customer.street2">
                                                    <tr>
                                                        <td><span t-field="delivery_customer.street2"/></td>
                                                    </tr>
                                                </t>
                                                <t t-if="delivery_customer.country_id and delivery_customer.country_id.code != 'SG'">
                                                    <td>
                                                        <span t-field="delivery_customer.city"/>
                                                        <t t-if="delivery_customer.city and delivery_customer.state_id">,&#160;</t>
                                                        <span t-field="delivery_customer.state_id"/>
                                                    </td>
                                                </t>
                                                <tr>
                                                    <td><span t-field="delivery_customer.country_id"/> <span t-field="delivery_customer.zip"/></td>
                                                </tr>
                                            </table>
                                        </td>
                                        <td style="width:36%; text-align:left; border-top:1px solid black; vertical-align:top !important; white-space:nowrap !important; padding-top:5px !important;">
                                            <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:3px;">
                                                <tr>
                                                    <td colspan="2" style="width:100%; text-align:center; font-size:15pt;">
                                                        <t t-if="o.state in ('draft', 'sent', 'cancel')">
                                                            <strong>QUOTATION</strong>
                                                        </t>
                                                        <t t-else="">
                                                            <strong>SALES ORDER</strong>
                                                        </t>

                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">
                                                        <t t-if="o.state in ('draft', 'sent', 'cancel')">
                                                            Quotation No.
                                                        </t>
                                                        <t t-else="">
                                                            Sales Order No.
                                                        </t>
                                                    </td>
                                                    <td style="width:54%;">: <span t-field="o.name"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">
                                                        <t t-if="o.state in ('draft', 'sent', 'cancel')">
                                                            Quotation Date
                                                        </t>
                                                        <t t-else="">
                                                            Sales Order Date
                                                        </t>
                                                    </td>
                                                    <td style="width:54%;">: <span t-field="o.date_order" t-options='{"widget": "date", "format": "dd MMM yyyy"}'/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">Delivery Date</td>
                                                    <td style="width:54%;">: <span t-field="o.commitment_date" t-options='{"widget": "date", "format": "dd MMM yyyy"}'/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">Delivery Mode</td>
                                                    <td style="width:54%;">: <span t-field="o.delivery_mode_id"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">Currency</td>
                                                    <td style="width:54%;">: <span t-field="o.currency_id"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">Payment Term</td>
                                                    <td style="width:54%;">: <span t-field="o.payment_term_id"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">Salesperson</td>
                                                    <td style="width:54%;">: <span t-field="o.user_id"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">Customer Service</td>
                                                    <td style="width:54%;">: <span t-field="o.customer_service_id"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:46%;">Purchase Order No.</td>
                                                    <td style="width:54%;">: <span t-field="o.customer_po"/></td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                    <!--<tr style="height:6px;"/>-->
                                    <tr>
                                        <td colspan="2" style="width:64%; text-align:left;">
                                            <t t-if="o.fg_attn">
                                                ATTN : <span t-field="o.fg_attn"/>
                                            </t>
                                            <t t-else="">
                                                ATTN : <span t-field="o.partner_id"/>
                                            </t>
                                        </td>
                                        <td rowspan="3" style="width:36%; text-align:left;">
                                            <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:3px;">
                                                <tr>
                                                    <td style="width:46%;">Country</td>
                                                    <td style="width:54%; padding-left:10px !important;">: <span t-field="o.partner_id.country_id"/></td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="width:64%; text-align:left;">
                                            Tel: <span t-field="contact_customer.phone"/>
                                            Mob: <span t-field="contact_customer.mobile"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="width:64%; text-align:left;">
                                            Email: <span t-field="contact_customer.email"/>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </thead>
                </table>
            </div>
        </template>

		<!-- Sales Order Report - Footer Layout	-->
		<template id="report_fg_sales_order_custom_footer_layout">
            <div class="footer">
                <style>
                    td {word-break: break-word !important; word-spacing: 3px !important; page-break-inside: avoid !important;}

                    .non-border, .non-border > tr, .non-border > tr > td {
                        border: none !important; border-color: #ffffff !important;
                    }
                </style>

                <table width="100%" class="non-border" cellpadding="0px" cellspacing="0px" style="font-family:Arial !important; font-size:10pt; padding:5px;">
                    <thead>
                        <tr>
                            <td style="width:66%; text-align:left; border-top:1px solid black; vertical-align:middle !important;">
                                Print By: <span t-esc="user.name"/> /
                                <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d-%b-%y %I:%M:%S %p')"/>
                            </td>
                            <td style="width:34%; text-align:right; border-top:1px solid black; vertical-align:middle !important;">
                                Page <span class="page"/> of <span class="topage"/>
                            </td>
                        </tr>
                    </thead>
                </table>
            </div>
        </template>

		<!-- Sales Order Report - Layout Call -->
		<template id="report_fg_sales_order_custom_layout">
            <t t-if="o and 'company_id' in o">
                <t t-set="company" t-value="o.company_id.sudo()"/>
            </t>
            <t t-if="not o or not 'company_id' in o">
                <t t-set="company" t-value="res_company"/>
            </t>
            <div class="article">
                <t t-call="flemings_base.report_fg_sales_order_custom_header_layout"/>
                <t t-out="0"/>
                <t t-call="flemings_base.report_fg_sales_order_custom_footer_layout"/>
            </div>
        </template>

        <!-- Hide Default Quotation Report -->
        <record id="sale.action_report_saleorder" model="ir.actions.report">
            <field name="binding_model_id" eval="False"/>
        </record>

        <!-- Allow updating on noupdate=True records -->
        <function name="write" model="ir.model.data">
	        <function name="search" model="ir.model.data">
	            <value eval="[('module', '=', 'sale'), ('name', '=', 'mail_template_sale_confirmation')]"/>
	        </function>
	        <value eval="{'noupdate': False}"/>
	    </function>
        <function name="write" model="ir.model.data">
	        <function name="search" model="ir.model.data">
	            <value eval="[('module', '=', 'sale'), ('name', '=', 'email_template_edi_sale')]"/>
	        </function>
	        <value eval="{'noupdate': False}"/>
	    </function>

        <!-- Update noupdate=1 record -->
        <record id="sale.mail_template_sale_confirmation" model="mail.template">
	        <field name="report_template" ref="flemings_base.print_report_fg_sales_order"/>
	    </record>
        <record id="sale.email_template_edi_sale" model="mail.template">
	        <field name="report_template" ref="flemings_base.print_report_fg_sales_order"/>
	    </record>

	    <!-- Revoke noupdate change -->
        <function name="write" model="ir.model.data">
	        <function name="search" model="ir.model.data">
	            <value eval="[('module', '=', 'sale'), ('name', '=', 'mail_template_sale_confirmation')]"/>
	        </function>
	        <value eval="{'noupdate': True}"/>
	    </function>
        <function name="write" model="ir.model.data">
	        <function name="search" model="ir.model.data">
	            <value eval="[('module', '=', 'sale'), ('name', '=', 'email_template_edi_sale')]"/>
	        </function>
	        <value eval="{'noupdate': True}"/>
	    </function>

        <!-- Complete page of the sale_order -->
    <template id="sale.sale_order_portal_template" name="Sales Order Portal Template" inherit_id="portal.portal_sidebar" primary="True">
        <xpath expr="//div[hasclass('o_portal_sidebar')]" position="inside">
            <t t-set="o_portal_fullwidth_alert" groups="sales_team.group_sale_salesman">
                <!-- Uses backend_url provided in rendering values -->
                <t t-call="portal.portal_back_in_edit_mode"/>
            </t>

            <div class="row mt16 o_portal_sale_sidebar">
                <!-- Sidebar -->
                <t t-call="portal.portal_record_sidebar">
                    <t t-set="classes" t-value="'col-lg-auto d-print-none'"/>

                    <t t-set="title">
                        <h2 class="mb-0"><b t-field="sale_order.amount_total" data-id="total_amount"/> </h2>
                    </t>
                    <t t-set="entries">
                        <ul class="list-group list-group-flush flex-wrap flex-row flex-lg-column">
                            <li class="list-group-item d-grid align-content-start">
                                <a t-if="sale_order._has_to_be_signed(True)" role="button" class="btn btn-primary mb8" data-bs-toggle="modal" data-bs-target="#modalaccept" href="#">
                                    <i class="fa fa-check"/><t t-if="sale_order._has_to_be_paid(True)"> Sign &amp; Pay</t><t t-else=""> Accept &amp; Sign</t>
                                </a>
                                <a t-elif="sale_order._has_to_be_paid(True)" role="button" id="o_sale_portal_paynow" data-bs-toggle="modal" data-bs-target="#modalaccept" href="#" t-att-class="'mb8 %s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')" >
                                    <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                                </a>
                                <div class="o_download_pdf btn-toolbar flex-sm-nowrap">
                                    <div class="btn-group flex-grow-1 me-1 mb-1">
                                        <a class="btn btn-secondary o_download_btn" t-att-href="sale_order.get_portal_url(report_type='pdf', download=True)" title="Download"><i class="fa fa-download"/> Download</a>
                                    </div>
                                    <div class="btn-group flex-grow-1 mb-1">
                                        <a class="btn btn-secondary o_print_btn o_portal_invoice_print" t-att-href="sale_order.get_portal_url(report_type='pdf')" id="print_invoice_report" title="Print" target="_blank"><i class="fa fa-print"/> Print</a>
                                    </div>
                                </div>
                            </li>

                            <li class="navspy list-group-item ps-0 flex-grow-1" t-ignore="true" role="complementary">
                                <ul class="nav flex-column bs-sidenav"></ul>
                            </li>

                            <t t-if="not sale_order.is_expired and sale_order.state in ['draft', 'sent']">
                                <li t-if="sale_order.validity_date" class="list-group-item">
                                    <small><b class="text-muted">This offer expires on</b></small>
                                    <div t-field="sale_order.validity_date"></div>
                                </li>
                                <li t-if="sale_order.amount_undiscounted - sale_order.amount_untaxed &gt; 0.01" class="list-group-item flex-grow-1">
                                    <small><b class="text-muted">Your advantage</b></small>
                                    <small>
                                        <b t-field="sale_order.amount_undiscounted"
                                            t-options='{"widget": "monetary", "display_currency": sale_order.pricelist_id.currency_id}'
                                            style="text-decoration: line-through"
                                            class="d-block mt-1"
                                            data-id="amount_undiscounted" />
                                    </small>
                                    <t t-if="sale_order.amount_untaxed == sale_order.amount_total">
                                        <h4 t-field="sale_order.amount_total" class="text-success" data-id="total_amount"/>
                                    </t>
                                    <t t-else="">
                                        <h4 t-field="sale_order.amount_untaxed" class="text-success mb-0" data-id="total_untaxed"/>
                                        <small>(<span t-field="sale_order.amount_total" data-id="total_amount"/> Incl. tax)</small>
                                    </t>
                                </li>
                            </t>

                            <li t-if="sale_order.user_id" class="list-group-item flex-grow-1">
                                <div class="small mb-1">
                                    <strong class="text-muted">Salesperson</strong>
                                </div>
                                <div class="row flex-nowrap">
                                    <div class="col flex-grow-0 pe-2">
                                        <img class="rounded-circle mr4 float-start o_portal_contact_img"
                                            t-att-src="image_data_uri(sale_order.user_id.avatar_1024)"
                                            alt="Contact"/>
                                    </div>
                                    <div class="col ps-0" style="min-width: 150px">
                                        <span t-field="sale_order.user_id"
                                            t-options='{"widget": "contact", "fields": ["name", "phone"], "no_marker": True}'/>
                                        <a href="#discussion" class="small">
                                            <i class="fa fa-comment"></i> Send message
                                        </a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </t>
                </t>

                <!-- Page content -->
                <div id="quote_content" class="col-12 col-lg justify-content-end">

                    <!-- modal relative to the actions sign and pay -->
                    <div role="dialog" class="modal fade" id="modalaccept">
                        <div class="modal-dialog" t-if="sale_order._has_to_be_signed(True)">
                            <form id="accept" method="POST" t-att-data-order-id="sale_order.id" t-att-data-token="sale_order.access_token" class="js_accept_json modal-content js_website_submit_form">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <header class="modal-header">
                                    <h4 class="modal-title">Validate Order</h4>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </header>
                                <main class="modal-body" id="sign-dialog">
                                    <p>
                                        <span>By signing this proposal, I agree to the following terms:</span>
                                        <ul>
                                            <li>
                                                <span>Accepted on the behalf of:</span> <b t-field="sale_order.partner_id.commercial_partner_id"/>
                                            </li>
                                            <li>
                                                <span>For an amount of:</span> <b data-id="total_amount" t-field="sale_order.amount_total"/>
                                            </li>
                                            <li t-if="sale_order.payment_term_id">
                                                <span>With payment terms:</span> <b t-field="sale_order.payment_term_id.note"/>
                                            </li>
                                        </ul>
                                    </p>
                                    <t t-call="portal.signature_form">
                                        <t t-set="call_url" t-value="sale_order.get_portal_url(suffix='/accept')"/>
                                        <t t-set="default_name" t-value="sale_order.partner_id.name"/>
                                    </t>
                                </main>
                            </form>
                        </div>

                        <div class="modal-dialog" t-if="not sale_order._has_to_be_signed(True) and sale_order._has_to_be_paid(True)">
                            <div class="modal-content">
                                <header class="modal-header">
                                    <h4 class="modal-title">Validate Order</h4>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </header>
                                <main class="modal-body" id="sign-dialog">
                                    <p>
                                        <span>By paying this proposal, I agree to the following terms:</span>
                                        <ul>
                                            <li>
                                                <span>Accepted on the behalf of:</span> <b t-field="sale_order.partner_id.commercial_partner_id"/>
                                            </li>
                                            <li>
                                                <span>For an amount of:</span> <b data-id="total_amount" t-field="sale_order.amount_total"/>
                                            </li>
                                            <li t-if="sale_order.payment_term_id">
                                                <span>With payment terms:</span> <b t-field="sale_order.payment_term_id.note"/>
                                            </li>
                                        </ul>
                                    </p>
                                    <div t-if="providers or tokens" id="payment_method" class="text-start">
                                        <h3 class="mb24">Pay with</h3>
                                        <t t-call="payment.checkout"/>
                                    </div>
                                    <div t-else="" class="alert alert-warning">
                                        <strong>No suitable payment option could be found.</strong><br/>
                                        If you believe that it is an error, please contact the website administrator.
                                    </div>
                                </main>
                            </div>
                        </div>
                    </div>

                    <!-- modal relative to the action reject -->
                    <div role="dialog" class="modal fade" id="modaldecline">
                        <div class="modal-dialog">
                            <form id="decline" method="POST" t-attf-action="/my/orders/#{sale_order.id}/decline?access_token=#{sale_order.access_token}" class="modal-content">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <header class="modal-header">
                                    <h4 class="modal-title">Reject This Quotation</h4>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </header>
                                <main class="modal-body">
                                    <p>
                                        Tell us why you are refusing this quotation, this will help us improve our services.
                                    </p>
                                    <textarea rows="4" name="decline_message" required="" placeholder="Your feedback..." class="form-control" />
                                </main>
                                <footer class="modal-footer">
                                    <button type="submit" t-att-id="sale_order.id" class="btn btn-danger">
                                        <i class="fa fa-times"></i> Reject
                                    </button>
                                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                                        Cancel
                                    </button>
                                </footer>
                            </form>
                        </div>
                    </div>

                    <!-- status messages -->
                    <div t-if="message == 'sign_ok'" class="alert alert-success alert-dismissible d-print-none" role="status">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        <strong>Thank You!</strong><br/>
                        <t t-if="message == 'sign_ok' and sale_order.state in ['sale', 'done']">
                            Your order has been confirmed.
                        </t>
                        <t t-elif="message == 'sign_ok' and sale_order._has_to_be_paid()">
                            Your order has been signed but still needs to be paid to be confirmed.
                        </t>
                        <t t-else="">Your order has been signed.</t>
                    </div>

                    <div t-if="message == 'cant_reject'" class="alert alert-danger alert-dismissible d-print-none" role="alert">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        Your order is not in a state to be rejected.
                    </div>

                    <t t-if="sale_order.transaction_ids">
                        <t t-call="payment.transaction_status">
                            <t t-set="tx" t-value="sale_order.get_portal_last_transaction()"/>
                        </t>
                    </t>

                    <div t-if="sale_order.state == 'cancel'" class="alert alert-danger alert-dismissible d-print-none" role="alert">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="close"></button>
                        <strong>This quotation has been canceled.</strong> <a role="button" href="#discussion"><i class="fa fa-comment"/> Contact us to get a new quotation.</a>
                    </div>

                    <div t-if="sale_order.is_expired" class="alert alert-warning alert-dismissible d-print-none" role="alert">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="close"></button>
                        <strong>This offer expired!</strong> <a role="button" href="#discussion"><i class="fa fa-comment"/> Contact us to get a new quotation.</a>
                    </div>

                    <!-- main content -->
                    <div t-attf-class="card #{'pb-5' if report_type == 'html' else ''}" id="portal_sale_content">
                        <!--<div t-call="sale.sale_order_portal_content"/>-->
                        <div class="card-body">
                            <t t-set="o" t-value="sale_order"/>
                            <div t-call="flemings_base.report_fg_sales_order_doc"/>
                        </div>
                    </div>

                    <!-- bottom actions -->
                    <div t-if="sale_order._has_to_be_signed(True) or sale_order._has_to_be_paid(True)" class="row justify-content-center text-center d-print-none pt-1 pb-4">

                        <t t-if="sale_order._has_to_be_signed(True)">
                            <div class="col-sm-auto mt8">
                                <a role="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalaccept" href="#"><i class="fa fa-check"/><t t-if="sale_order._has_to_be_paid(True)"> Sign &amp; Pay</t><t t-else=""> Accept &amp; Sign</t></a>
                            </div>
                            <div class="col-sm-auto mt8">
                                <a role="button" class="btn btn-secondary" href="#discussion"><i class="fa fa-comment"/> Feedback</a>
                            </div>
                            <div class="col-sm-auto mt8">
                                <a role="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modaldecline" href="#"> <i class="fa fa-times"/> Reject</a>
                            </div>
                        </t>
                        <div t-elif="sale_order._has_to_be_paid(True)" class="col-sm-auto mt8">
                            <a role="button" data-bs-toggle="modal" data-bs-target="#modalaccept" href="#" t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                                <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                            </a>
                        </div>
                    </div>

                    <!-- chatter -->
                    <div id="sale_order_communication" class="mt-4">
                        <h2>History</h2>
                        <t t-call="portal.message_thread"/>
                    </div>
                </div><!-- // #quote_content -->
            </div>
        </xpath>
    </template>

    </data>
</odoo>

